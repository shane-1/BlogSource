{"code":"(window.webpackJsonp=window.webpackJsonp||[]).push([[12],{452:function(s,t,a){\"use strict\";a.r(t);var e=a(28),n=Object(e.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a(\"ContentSlotsDistributor\",{attrs:{\"slot-key\":s.$parent.slotKey}},[a(\"h1\",{attrs:{id:\"在k8s上部署redis-集群\"}},[a(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#在k8s上部署redis-集群\"}},[s._v(\"#\")]),s._v(\" 在K8s上部署Redis 集群\")]),s._v(\" \"),a(\"p\",[s._v(\"转载自\"),a(\"a\",{attrs:{href:\"https://blog.csdn.net/zhutongcloud/article/details/90768390\",target:\"_blank\",rel:\"noopener noreferrer\"}},[s._v(\"朱溪红的博客\"),a(\"OutboundLink\")],1)]),s._v(\" \"),a(\"h2\",{attrs:{id:\"一、前言\"}},[a(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#一、前言\"}},[s._v(\"#\")]),s._v(\" 一、前言\")]),s._v(\" \"),a(\"p\",[s._v(\"架构原理：每个Master都可以拥有多个Slave。当Master下线后，Redis集群会从多个Slave中选举出一个新的Master作为替代，而旧Master重新上线后变成新Master的Slave。\")]),s._v(\" \"),a(\"h2\",{attrs:{id:\"二、准备操作\"}},[a(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#二、准备操作\"}},[s._v(\"#\")]),s._v(\" 二、准备操作\")]),s._v(\" \"),a(\"p\",[s._v(\"本次部署主要基于该项目：\")]),s._v(\" \"),a(\"div\",{staticClass:\"language- extra-class\"},[a(\"pre\",{pre:!0,attrs:{class:\"language-text\"}},[a(\"code\",[s._v(\"https://github.com/zuxqoj/kubernetes-redis-cluster\\n\")])])]),a(\"p\",[s._v(\"其包含了两种部署Redis集群的方式：\")]),s._v(\" \"),a(\"ul\",[a(\"li\",[s._v(\"StatefulSet\")]),s._v(\" \"),a(\"li\",[s._v(\"Service&Deployment\")])]),s._v(\" \"),a(\"p\",[s._v(\"两种方式各有优劣，对于像Redis、Mongodb、Zookeeper等有状态的服务，使用StatefulSet是首选方式。本文将主要介绍如何使用StatefulSet进行Redis集群的部署。\")]),s._v(\" \"),a(\"h2\",{attrs:{id:\"三、statefulset简介\"}},[a(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#三、statefulset简介\"}},[s._v(\"#\")]),s._v(\" 三、StatefulSet简介\")]),s._v(\" \"),a(\"p\",[s._v(\"RC、Deployment、DaemonSet都是面向无状态的服务，它们所管理的Pod的IP、名字，启停顺序等都是随机的，而StatefulSet是什么？顾名思义，有状态的集合，管理所有有状态的服务，比如MySQL、MongoDB集群等。\\nStatefulSet本质上是Deployment的一种变体，在v1.9版本中已成为GA版本，它为了解决有状态服务的问题，它所管理的Pod拥有固定的Pod名称，启停顺序，在StatefulSet中，Pod名字称为网络标识(hostname)，还必须要用到共享存储。\\n\"),a(\"strong\",[s._v(\"在Deployment中，与之对应的服务是service，而在StatefulSet中与之对应的headless service，headless service，即无头服务，与service的区别就是它没有Cluster IP，解析它的名称时将返回该Headless Service对应的全部Pod的Endpoint列表。\")]),s._v(\"\\n除此之外，StatefulSet在Headless Service的基础上又为StatefulSet控制的每个Pod副本创建了一个DNS域名，这个域名的格式为：\")]),s._v(\" \"),a(\"div\",{staticClass:\"language- extra-class\"},[a(\"pre\",{pre:!0,attrs:{class:\"language-text\"}},[a(\"code\",[s._v(\"$(podname).(headless server name)   \\nFQDN： $(podname).(headless server name).namespace.svc.cluster.local\\n\")])])]),a(\"p\",[s._v(\"也即是说，对于有状态服务，我们最好使用固定的网络标识（如域名信息）来标记节点，当然这也需要应用程序的支持（如Zookeeper就支持在配置文件中写入主机域名）。\\nStatefulSet基于Headless Service（即没有Cluster IP的Service）为Pod实现了稳定的网络标志（包括Pod的hostname和DNS Records），在Pod重新调度后也保持不变。同时，结合PV/PVC，StatefulSet可以实现稳定的持久化存储，就算Pod重新调度后，还是能访问到原先的持久化数据。\\n以下为使用StatefulSet部署Redis的架构，无论是Master还是Slave，都作为StatefulSet的一个副本，并且数据通过PV进行持久化，对外暴露为一个Service，接受客户端请求。\")]),s._v(\" \"),a(\"h2\",{attrs:{id:\"四、部署过程\"}},[a(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#四、部署过程\"}},[s._v(\"#\")]),s._v(\" 四、部署过程\")]),s._v(\" \"),a(\"p\",[s._v(\"本文参考项目的README中，简要介绍了基于StatefulSet的Redis创建步骤：\")]),s._v(\" \"),a(\"ol\",[a(\"li\",[s._v(\"创建NFS存储\")]),s._v(\" \"),a(\"li\",[s._v(\"创建PV\")]),s._v(\" \"),a(\"li\",[s._v(\"创建PVC\")]),s._v(\" \"),a(\"li\",[s._v(\"创建Configmap\")]),s._v(\" \"),a(\"li\",[s._v(\"创建headless服务\")]),s._v(\" \"),a(\"li\",[s._v(\"创建Redis StatefulSet\")]),s._v(\" \"),a(\"li\",[s._v(\"初始化Redis集群\")])]),s._v(\" \"),a(\"p\",[s._v(\"这里，我将参考如上步骤，实践操作并详细介绍Redis集群的部署过程。文中会涉及到很多K8S的概念，希望大家能提前了解学习\")]),s._v(\" \"),a(\"h3\",{attrs:{id:\"_1-创建nfs存储\"}},[a(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_1-创建nfs存储\"}},[s._v(\"#\")]),s._v(\" 1. 创建NFS存储\")]),s._v(\" \"),a(\"p\",[s._v(\"创建NFS存储主要是为了给Redis提供稳定的后端存储，当Redis的Pod重启或迁移后，依然能获得原先的数据。这里，我们先要创建NFS，然后通过使用PV为Redis挂载一个远程的NFS路径。\")]),s._v(\" \"),a(\"p\",[a(\"strong\",[s._v(\"安装NFS\")])]),s._v(\" \"),a(\"div\",{staticClass:\"language-bash extra-class\"},[a(\"pre\",{pre:!0,attrs:{class:\"language-bash\"}},[a(\"code\",[s._v(\"yum -y \"),a(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"install\")]),s._v(\" nfs-utils（主包提供文件系统）\\nyum -y \"),a(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"install\")]),s._v(\" rpcbind（提供rpc协议）\\n\")])])]),a(\"p\",[s._v(\"然后，新增/etc/exports文件，用于设置需要共享的路径：\")]),s._v(\" \"),a(\"div\",{staticClass:\"language-bash extra-class\"},[a(\"pre\",{pre:!0,attrs:{class:\"language-bash\"}},[a(\"code\",[a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"[\")]),s._v(\"root@ftp pv3\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"]\")]),a(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"# cat /etc/exports\")]),s._v(\"\\n/usr/local/k8s/redis/pv1 \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"192.168\")]),s._v(\".0.0/24\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),s._v(\"rw,sync,no_root_squash\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\"\\n/usr/local/k8s/redis/pv2 \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"192.168\")]),s._v(\".0.0/24\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),s._v(\"rw,sync,no_root_squash\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\"\\n/usr/local/k8s/redis/pv3 \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"192.168\")]),s._v(\".0.0/24\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),s._v(\"rw,sync,no_root_squash\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\"\\n/usr/local/k8s/redis/pv4 \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"192.168\")]),s._v(\".0.0/24\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),s._v(\"rw,sync,no_root_squash\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\"\\n/usr/local/k8s/redis/pv5 \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"192.168\")]),s._v(\".0.0/24\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),s._v(\"rw,sync,no_root_squash\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\"\\n/usr/local/k8s/redis/pv6 \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"192.168\")]),s._v(\".0.0/24\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),s._v(\"rw,sync,no_root_squash\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\"\\n\")])])]),a(\"p\",[a(\"img\",{attrs:{src:\"/images/2020-11-18-14-42-51.png\",alt:\"\"}})]),s._v(\" \"),a(\"p\",[s._v(\"创建相应目录\")]),s._v(\" \"),a(\"div\",{staticClass:\"language- extra-class\"},[a(\"pre\",{pre:!0,attrs:{class:\"language-text\"}},[a(\"code\",[s._v(\"[root@ftp quizii]# mkdir -p /usr/local/k8s/redis/pv{1..6}\\n\")])])]),a(\"p\",[s._v(\"接着，启动NFS和rpcbind服务：\")]),s._v(\" \"),a(\"div\",{staticClass:\"language-bash extra-class\"},[a(\"pre\",{pre:!0,attrs:{class:\"language-bash\"}},[a(\"code\",[s._v(\"systemctl restart rpcbind\\nsystemctl restart nfs\\nsystemctl \"),a(\"span\",{pre:!0,attrs:{class:\"token builtin class-name\"}},[s._v(\"enable\")]),s._v(\" nfs\\n\")])])]),a(\"div\",{staticClass:\"language-bash extra-class\"},[a(\"pre\",{pre:!0,attrs:{class:\"language-bash\"}},[a(\"code\",[a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"[\")]),s._v(\"root@ftp pv3\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"]\")]),a(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"# exportfs -v\")]),s._v(\"\\n/usr/local/k8s/redis/pv1\\n\\t\"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"192.168\")]),s._v(\".0.0/24\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),s._v(\"sync,wdelay,hide,no_subtree_check,sec\"),a(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),s._v(\"sys,rw,secure,no_root_squash,no_all_squash\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\"\\n/usr/local/k8s/redis/pv2\\n\\t\"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"192.168\")]),s._v(\".0.0/24\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),s._v(\"sync,wdelay,hide,no_subtree_check,sec\"),a(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),s._v(\"sys,rw,secure,no_root_squash,no_all_squash\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\"\\n/usr/local/k8s/redis/pv3\\n\\t\"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"192.168\")]),s._v(\".0.0/24\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),s._v(\"sync,wdelay,hide,no_subtree_check,sec\"),a(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),s._v(\"sys,rw,secure,no_root_squash,no_all_squash\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\"\\n/usr/local/k8s/redis/pv4\\n\\t\"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"192.168\")]),s._v(\".0.0/24\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),s._v(\"sync,wdelay,hide,no_subtree_check,sec\"),a(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),s._v(\"sys,rw,secure,no_root_squash,no_all_squash\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\"\\n/usr/local/k8s/redis/pv5\\n\\t\"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"192.168\")]),s._v(\".0.0/24\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),s._v(\"sync,wdelay,hide,no_subtree_check,sec\"),a(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),s._v(\"sys,rw,secure,no_root_squash,no_all_squash\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\"\\n/usr/local/k8s/redis/pv6\\n\\t\"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"192.168\")]),s._v(\".0.0/24\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),s._v(\"sync,wdelay,hide,no_subtree_check,sec\"),a(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),s._v(\"sys,rw,secure,no_root_squash,no_all_squash\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\"\\n\")])])]),a(\"p\",[s._v(\"客户端\")]),s._v(\" \"),a(\"div\",{staticClass:\"language-bash extra-class\"},[a(\"pre\",{pre:!0,attrs:{class:\"language-bash\"}},[a(\"code\",[s._v(\"yum -y \"),a(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"install\")]),s._v(\" nfs-utils\\n\")])])]),a(\"p\",[s._v(\"查看存储端共享\")]),s._v(\" \"),a(\"div\",{staticClass:\"language-bash extra-class\"},[a(\"pre\",{pre:!0,attrs:{class:\"language-bash\"}},[a(\"code\",[a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"[\")]),s._v(\"root@node2 ~\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"]\")]),a(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"# showmount -e 192.168.0.222\")]),s._v(\"\\nExport list \"),a(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"for\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"192.168\")]),s._v(\".0.222:\\n/usr/local/k8s/redis/pv6 \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"192.168\")]),s._v(\".0.0/24\\n/usr/local/k8s/redis/pv5 \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"192.168\")]),s._v(\".0.0/24\\n/usr/local/k8s/redis/pv4 \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"192.168\")]),s._v(\".0.0/24\\n/usr/local/k8s/redis/pv3 \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"192.168\")]),s._v(\".0.0/24\\n/usr/local/k8s/redis/pv2 \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"192.168\")]),s._v(\".0.0/24\\n/usr/local/k8s/redis/pv1 \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"192.168\")]),s._v(\".0.0/24\\n\")])])]),a(\"p\",[a(\"strong\",[s._v(\"创建PV\")]),s._v(\"\\n每一个Redis Pod都需要一个独立的PV来存储自己的数据，因此可以创建一个pv.yaml文件，包含6个PV：\")]),s._v(\" \"),a(\"div\",{staticClass:\"language-yml extra-class\"},[a(\"pre\",{pre:!0,attrs:{class:\"language-yml\"}},[a(\"code\",[a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"[\")]),s._v(\"root@master redis\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"]\")]),a(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"# cat pv.yaml \")]),s._v(\"\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"apiVersion\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" v1\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"kind\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" PersistentVolume\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"metadata\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n  \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"name\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" nfs\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"-\")]),s._v(\"pv1\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"spec\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n  \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"capacity\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n    \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"storage\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" 200M\\n  \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"accessModes\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n    \"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"-\")]),s._v(\" ReadWriteMany\\n  \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"nfs\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n    \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"server\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" 192.168.0.222\\n    \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"path\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"/usr/local/k8s/redis/pv1\"')]),s._v(\"\\n\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"---\")]),s._v(\"\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"apiVersion\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" v1\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"kind\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" PersistentVolume\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"metadata\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n  \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"name\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" nfs\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"-\")]),s._v(\"vp2\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"spec\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n  \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"capacity\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n    \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"storage\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" 200M\\n  \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"accessModes\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n    \"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"-\")]),s._v(\" ReadWriteMany\\n  \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"nfs\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n    \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"server\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" 192.168.0.222\\n    \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"path\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"/usr/local/k8s/redis/pv2\"')]),s._v(\"\\n\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"---\")]),s._v(\"\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"apiVersion\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" v1\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"kind\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" PersistentVolume\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"metadata\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n  \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"name\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" nfs\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"-\")]),s._v(\"pv3\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"spec\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n  \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"capacity\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n    \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"storage\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" 200M\\n  \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"accessModes\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n    \"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"-\")]),s._v(\" ReadWriteMany\\n  \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"nfs\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n    \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"server\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" 192.168.0.222\\n    \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"path\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"/usr/local/k8s/redis/pv3\"')]),s._v(\"\\n\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"---\")]),s._v(\"\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"apiVersion\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" v1\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"kind\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" PersistentVolume\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"metadata\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n  \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"name\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" nfs\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"-\")]),s._v(\"pv4\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"spec\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n  \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"capacity\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n    \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"storage\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" 200M\\n  \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"accessModes\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n    \"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"-\")]),s._v(\" ReadWriteMany\\n  \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"nfs\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n    \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"server\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" 192.168.0.222\\n    \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"path\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"/usr/local/k8s/redis/pv4\"')]),s._v(\"\\n\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"---\")]),s._v(\"\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"apiVersion\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" v1\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"kind\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" PersistentVolume\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"metadata\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n  \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"name\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" nfs\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"-\")]),s._v(\"pv5\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"spec\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n  \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"capacity\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n    \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"storage\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" 200M\\n  \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"accessModes\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n    \"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"-\")]),s._v(\" ReadWriteMany\\n  \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"nfs\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n    \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"server\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" 192.168.0.222\\n    \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"path\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"/usr/local/k8s/redis/pv5\"')]),s._v(\"\\n\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"---\")]),s._v(\"\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"apiVersion\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" v1\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"kind\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" PersistentVolume\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"metadata\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n  \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"name\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" nfs\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"-\")]),s._v(\"pv6\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"spec\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n  \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"capacity\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n    \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"storage\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" 200M\\n  \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"accessModes\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n    \"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"-\")]),s._v(\" ReadWriteMany\\n  \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"nfs\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n    \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"server\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" 192.168.0.222\\n    \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"path\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"/usr/local/k8s/redis/pv6\"')]),s._v(\"\\n\")])])]),a(\"p\",[s._v(\"如上，可以看到所有PV除了名称和挂载的路径外都基本一致。执行创建即可：\")]),s._v(\" \"),a(\"div\",{staticClass:\"language-bash extra-class\"},[a(\"pre\",{pre:!0,attrs:{class:\"language-bash\"}},[a(\"code\",[a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"[\")]),s._v(\"root@master redis\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"]\")]),a(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"#kubectl create -f pv.yaml \")]),s._v(\"\\npersistentvolume \"),a(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"nfs-pv1\"')]),s._v(\" created\\npersistentvolume \"),a(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"nfs-pv2\"')]),s._v(\" created\\npersistentvolume \"),a(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"nfs-pv3\"')]),s._v(\" created\\npersistentvolume \"),a(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"nfs-pv4\"')]),s._v(\" created\\npersistentvolume \"),a(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"nfs-pv5\"')]),s._v(\" created\\npersistentvolume \"),a(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"nfs-pv6\"')]),s._v(\" created\\n\")])])]),a(\"h3\",{attrs:{id:\"_2-创建configmap\"}},[a(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_2-创建configmap\"}},[s._v(\"#\")]),s._v(\" 2.创建Configmap\")]),s._v(\" \"),a(\"p\",[s._v(\"这里，我们可以直接将Redis的配置文件转化为Configmap，这是一种更方便的配置读取方式。配置文件redis.conf如下\")]),s._v(\" \"),a(\"div\",{staticClass:\"language-bash extra-class\"},[a(\"pre\",{pre:!0,attrs:{class:\"language-bash\"}},[a(\"code\",[a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"[\")]),s._v(\"root@master redis\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"]\")]),a(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"# cat redis.conf \")]),s._v(\"\\nappendonly \"),a(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"yes\")]),s._v(\"\\ncluster-enabled \"),a(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"yes\")]),s._v(\"\\ncluster-config-file /var/lib/redis/nodes.conf\\ncluster-node-timeout \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"5000\")]),s._v(\"\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"dir\")]),s._v(\" /var/lib/redis\\nport \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"6379\")]),s._v(\"\\n\\n\")])])]),a(\"p\",[s._v(\"创建名为redis-conf的Configmap：\")]),s._v(\" \"),a(\"div\",{staticClass:\"language-bash extra-class\"},[a(\"pre\",{pre:!0,attrs:{class:\"language-bash\"}},[a(\"code\",[s._v(\"kubectl create configmap redis-conf --from-file\"),a(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),s._v(\"redis.conf\\n\")])])]),a(\"p\",[s._v(\"查看创建的configmap:\")]),s._v(\" \"),a(\"div\",{staticClass:\"language-bash extra-class\"},[a(\"pre\",{pre:!0,attrs:{class:\"language-bash\"}},[a(\"code\",[a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"[\")]),s._v(\"root@master redis\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"]\")]),a(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"# kubectl describe cm redis-conf\")]),s._v(\"\\nName:         redis-conf\\nNamespace:    default\\nLabels:       \"),a(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"<\")]),s._v(\"none\"),a(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\">\")]),s._v(\"\\nAnnotations:  \"),a(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"<\")]),s._v(\"none\"),a(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\">\")]),s._v(\"\\n\\nData\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"==\")]),a(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"==\")]),s._v(\"\\nredis.conf:\\n----\\nappendonly \"),a(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"yes\")]),s._v(\"\\ncluster-enabled \"),a(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"yes\")]),s._v(\"\\ncluster-config-file /var/lib/redis/nodes.conf\\ncluster-node-timeout \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"5000\")]),s._v(\"\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"dir\")]),s._v(\" /var/lib/redis\\nport \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"6379\")]),s._v(\"\\n\\nEvents:  \"),a(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"<\")]),s._v(\"none\"),a(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\">\")]),s._v(\"\\n\")])])]),a(\"p\",[s._v(\"如上，redis.conf中的所有配置项都保存到redis-conf这个Configmap中。\")]),s._v(\" \"),a(\"h3\",{attrs:{id:\"_3-创建headless-service\"}},[a(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_3-创建headless-service\"}},[s._v(\"#\")]),s._v(\" 3.创建Headless service\")]),s._v(\" \"),a(\"p\",[s._v(\"Headless service是StatefulSet实现稳定网络标识的基础，我们需要提前创建。准备文件headless-service.yml如下：\")]),s._v(\" \"),a(\"div\",{staticClass:\"language-yml extra-class\"},[a(\"pre\",{pre:!0,attrs:{class:\"language-yml\"}},[a(\"code\",[a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"[\")]),s._v(\"root@master redis\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"]\")]),a(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"# cat headless-service.yaml \")]),s._v(\"\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"apiVersion\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" v1\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"kind\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" Service\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"metadata\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n  \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"name\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" redis\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"-\")]),s._v(\"service\\n  \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"labels\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n    \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"app\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" redis\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"spec\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n  \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"ports\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n  \"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"-\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"name\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" redis\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"-\")]),s._v(\"port\\n    \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"port\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"6379\")]),s._v(\"\\n  \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"clusterIP\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" None\\n  \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"selector\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n    \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"app\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" redis\\n    \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"appCluster\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" redis\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"-\")]),s._v(\"cluster\\n\\n\")])])]),a(\"p\",[s._v(\"创建：\")]),s._v(\" \"),a(\"div\",{staticClass:\"language-bash extra-class\"},[a(\"pre\",{pre:!0,attrs:{class:\"language-bash\"}},[a(\"code\",[s._v(\"kubectl create -f headless-service.yml\\n\")])])]),a(\"p\",[s._v(\"查看：\\n\"),a(\"img\",{attrs:{src:\"/images/2020-11-18-15-17-05.png\",alt:\"\"}})]),s._v(\" \"),a(\"p\",[s._v(\"可以看到，服务名称为redis-service，其CLUSTER-IP为None，表示这是一个“无头”服务。\")]),s._v(\" \"),a(\"h3\",{attrs:{id:\"_4-创建redis-集群节点\"}},[a(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_4-创建redis-集群节点\"}},[s._v(\"#\")]),s._v(\" 4.创建Redis 集群节点\")]),s._v(\" \"),a(\"p\",[s._v(\"创建好Headless service后，就可以利用StatefulSet创建Redis 集群节点，这也是本文的核心内容。我们先创建redis.yml文件：\")]),s._v(\" \"),a(\"div\",{staticClass:\"language-yml extra-class\"},[a(\"pre\",{pre:!0,attrs:{class:\"language-yml\"}},[a(\"code\",[a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"[\")]),s._v(\"root@master redis\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"]\")]),a(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"# cat redis.yaml \")]),s._v(\"\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"apiVersion\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" apps/v1beta1\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"kind\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" StatefulSet\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"metadata\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n  \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"name\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" redis\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"-\")]),s._v(\"app\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"spec\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n  \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"serviceName\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"redis-service\"')]),s._v(\"\\n  \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"replicas\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"6\")]),s._v(\"\\n  \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"template\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n    \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"metadata\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n      \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"labels\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n        \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"app\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" redis\\n        \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"appCluster\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" redis\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"-\")]),s._v(\"cluster\\n    \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"spec\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n      \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"terminationGracePeriodSeconds\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"20\")]),s._v(\"\\n      \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"affinity\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n        \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"podAntiAffinity\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n          \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"preferredDuringSchedulingIgnoredDuringExecution\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n          \"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"-\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"weight\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"100\")]),s._v(\"\\n            \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"podAffinityTerm\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n              \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"labelSelector\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n                \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"matchExpressions\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n                \"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"-\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"key\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" app\\n                  \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"operator\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" In\\n                  \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"values\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n                  \"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"-\")]),s._v(\" redis\\n              \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"topologyKey\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" kubernetes.io/hostname\\n      \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"containers\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n      \"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"-\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"name\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" redis\\n        \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"image\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" redis\\n        \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"command\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n          \"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"-\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"redis-server\"')]),s._v(\"\\n        \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"args\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n          \"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"-\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"/etc/redis/redis.conf\"')]),s._v(\"\\n          \"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"-\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"--protected-mode\"')]),s._v(\"\\n          \"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"-\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"no\"')]),s._v(\"\\n        \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"resources\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n          \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"requests\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n            \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"cpu\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"100m\"')]),s._v(\"\\n            \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"memory\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"100Mi\"')]),s._v(\"\\n        \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"ports\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n            \"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"-\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"name\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" redis\\n              \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"containerPort\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"6379\")]),s._v(\"\\n              \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"protocol\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"TCP\"')]),s._v(\"\\n            \"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"-\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"name\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" cluster\\n              \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"containerPort\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"16379\")]),s._v(\"\\n              \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"protocol\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"TCP\"')]),s._v(\"\\n        \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"volumeMounts\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n          \"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"-\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"name\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"redis-conf\"')]),s._v(\"\\n            \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"mountPath\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"/etc/redis\"')]),s._v(\"\\n          \"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"-\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"name\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"redis-data\"')]),s._v(\"\\n            \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"mountPath\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"/var/lib/redis\"')]),s._v(\"\\n      \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"volumes\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n      \"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"-\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"name\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"redis-conf\"')]),s._v(\"\\n        \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"configMap\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n          \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"name\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"redis-conf\"')]),s._v(\"\\n          \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"items\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n            \"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"-\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"key\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"redis.conf\"')]),s._v(\"\\n              \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"path\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"redis.conf\"')]),s._v(\"\\n  \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"volumeClaimTemplates\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n  \"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"-\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"metadata\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n      \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"name\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" redis\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"-\")]),s._v(\"data\\n    \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"spec\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n      \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"accessModes\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"[\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"ReadWriteMany\"')]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"]\")]),s._v(\"\\n      \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"resources\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n        \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"requests\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n          \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"storage\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" 200M\\n\")])])]),a(\"p\",[s._v(\"如上，总共创建了6个Redis节点(Pod)，其中3个将用于master，另外3个分别作为master的slave；Redis的配置通过volume将之前生成的redis-conf这个Configmap，挂载到了容器的/etc/redis/redis.conf；Redis的数据存储路径使用volumeClaimTemplates声明（也就是PVC），其会绑定到我们先前创建的PV上。\\n这里有一个关键概念——Affinity，请参考官方文档详细了解。其中，podAntiAffinity表示反亲和性，其决定了某个pod不可以和哪些Pod部署在同一拓扑域，可以用于将一个服务的POD分散在不同的主机或者拓扑域中，提高服务本身的稳定性。\\n而PreferredDuringSchedulingIgnoredDuringExecution 则表示，在调度期间尽量满足亲和性或者反亲和性规则，如果不能满足规则，POD也有可能被调度到对应的主机上。在之后的运行过程中，系统不会再检查这些规则是否满足。\\n在这里，matchExpressions规定了Redis Pod要尽量不要调度到包含app为redis的Node上，也即是说已经存在Redis的Node上尽量不要再分配Redis Pod了。但是，由于我们只有三个Node，而副本有6个，因此根据PreferredDuringSchedulingIgnoredDuringExecution，这些豌豆不得不得挤一挤，挤挤更健康~\\n另外，根据StatefulSet的规则，我们生成的Redis的6个Pod的hostname会被依次命名为 \"),a(\"code\",[s._v(\"$(statefulset名称)-$(序号)\")]),s._v(\" 如下图所示：\")]),s._v(\" \"),a(\"div\",{staticClass:\"language-bash extra-class\"},[a(\"pre\",{pre:!0,attrs:{class:\"language-bash\"}},[a(\"code\",[a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"[\")]),s._v(\"root@master redis\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"]\")]),a(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"# kubectl get pods -o wide \")]),s._v(\"\\nNAME                                            READY     STATUS      RESTARTS   AGE       IP             NODE            NOMINATED NODE\\nredis-app-0                                     \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"1\")]),s._v(\"/1       Running     \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"0\")]),s._v(\"          2h        \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"172.17\")]),s._v(\".24.3    \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"192.168\")]),s._v(\".0.144   \"),a(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"<\")]),s._v(\"none\"),a(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\">\")]),s._v(\"\\nredis-app-1                                     \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"1\")]),s._v(\"/1       Running     \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"0\")]),s._v(\"          2h        \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"172.17\")]),s._v(\".63.8    \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"192.168\")]),s._v(\".0.148   \"),a(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"<\")]),s._v(\"none\"),a(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\">\")]),s._v(\"\\nredis-app-2                                     \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"1\")]),s._v(\"/1       Running     \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"0\")]),s._v(\"          2h        \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"172.17\")]),s._v(\".24.8    \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"192.168\")]),s._v(\".0.144   \"),a(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"<\")]),s._v(\"none\"),a(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\">\")]),s._v(\"\\nredis-app-3                                     \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"1\")]),s._v(\"/1       Running     \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"0\")]),s._v(\"          2h        \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"172.17\")]),s._v(\".63.9    \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"192.168\")]),s._v(\".0.148   \"),a(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"<\")]),s._v(\"none\"),a(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\">\")]),s._v(\"\\nredis-app-4                                     \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"1\")]),s._v(\"/1       Running     \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"0\")]),s._v(\"          2h        \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"172.17\")]),s._v(\".24.9    \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"192.168\")]),s._v(\".0.144   \"),a(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"<\")]),s._v(\"none\"),a(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\">\")]),s._v(\"\\nredis-app-5                                     \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"1\")]),s._v(\"/1       Running     \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"0\")]),s._v(\"          2h        \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"172.17\")]),s._v(\".63.10   \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"192.168\")]),s._v(\".0.148   \"),a(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"<\")]),s._v(\"none\"),a(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\">\")]),s._v(\"\\n\")])])]),a(\"p\",[s._v(\"如上，可以看到这些Pods在部署时是以{0…N-1}的顺序依次创建的。注意，直到redis-app-0状态启动后达到Running状态之后，redis-app-1 才开始启动。\\n同时，每个Pod都会得到集群内的一个DNS域名，格式为\"),a(\"code\",[s._v(\"$(podname).$(service name).$(namespace).svc.cluster.local\")]),s._v(\" ，也即是：\")]),s._v(\" \"),a(\"div\",{staticClass:\"language-xml extra-class\"},[a(\"pre\",{pre:!0,attrs:{class:\"language-xml\"}},[a(\"code\",[s._v(\"redis-app-0.redis-service.default.svc.cluster.local\\nredis-app-1.redis-service.default.svc.cluster.local\\n...以此类推...\\n\")])])]),a(\"p\",[s._v(\"在K8S集群内部，这些Pod就可以利用该域名互相通信。我们可以使用busybox镜像的nslookup检验这些域名：\")]),s._v(\" \"),a(\"div\",{staticClass:\"language-bash extra-class\"},[a(\"pre\",{pre:!0,attrs:{class:\"language-bash\"}},[a(\"code\",[a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"[\")]),s._v(\"root@master redis\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"]\")]),a(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"# kubectl exec -ti busybox -- nslookup redis-app-0.redis-service\")]),s._v(\"\\nServer:    \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"10.0\")]),s._v(\".0.2\\nAddress \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"1\")]),s._v(\": \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"10.0\")]),s._v(\".0.2 kube-dns.kube-system.svc.cluster.local\\n\\nName:      redis-app-0.redis-service\\nAddress \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"1\")]),s._v(\": \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"172.17\")]),s._v(\".24.3\\n\")])])]),a(\"p\",[a(\"strong\",[s._v(\"可以看到， redis-app-0的IP为172.17.24.3。*当然，若Redis Pod迁移或是重启（我们可以手动删除掉一个Redis Pod来测试），IP是会改变的*，但是Pod的域名、SRV records、A record都不会改变。\")])]),s._v(\" \"),a(\"p\",[s._v(\"另外可以发现，我们之前创建的pv都被成功绑定了：\")]),s._v(\" \"),a(\"div\",{staticClass:\"language-bash extra-class\"},[a(\"pre\",{pre:!0,attrs:{class:\"language-bash\"}},[a(\"code\",[a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"[\")]),s._v(\"root@master redis\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"]\")]),a(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"# kubectl get pv\")]),s._v(\"\\nNAME      CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS    CLAIM                            STORAGECLASS   REASON    AGE\\nnfs-pv1   200M       RWX            Retain           Bound     default/redis-data-redis-app-2                            3h\\nnfs-pv3   200M       RWX            Retain           Bound     default/redis-data-redis-app-4                            3h\\nnfs-pv4   200M       RWX            Retain           Bound     default/redis-data-redis-app-5                            3h\\nnfs-pv5   200M       RWX            Retain           Bound     default/redis-data-redis-app-1                            3h\\nnfs-pv6   200M       RWX            Retain           Bound     default/redis-data-redis-app-0                            3h\\nnfs-vp2   200M       RWX            Retain           Bound     default/redis-data-redis-app-3                            3h\\n\")])])]),a(\"h3\",{attrs:{id:\"_5-初始化redis集群\"}},[a(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_5-初始化redis集群\"}},[s._v(\"#\")]),s._v(\" 5.初始化Redis集群\")]),s._v(\" \"),a(\"p\",[s._v(\"创建好6个Redis Pod后，我们还需要利用常用的Redis-tribe工具进行集群的初始化\")]),s._v(\" \"),a(\"p\",[a(\"strong\",[s._v(\"创建Ubuntu容器\")]),s._v(\"\\n由于Redis集群必须在所有节点启动后才能进行初始化，而如果将初始化逻辑写入Statefulset中，则是一件非常复杂而且低效的行为。这里，本人不得不称赞一下原项目作者的思路，值得学习。也就是说，我们可以在K8S上创建一个额外的容器，专门用于进行K8S集群内部某些服务的管理控制。\\n这里，我们专门启动一个Ubuntu的容器，可以在该容器中安装Redis-tribe，进而初始化Redis集群，执行：\")]),s._v(\" \"),a(\"div\",{staticClass:\"language-bash extra-class\"},[a(\"pre\",{pre:!0,attrs:{class:\"language-bash\"}},[a(\"code\",[s._v(\"kubectl run -it ubuntu --image\"),a(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),s._v(\"ubuntu --restart\"),a(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),s._v(\"Never /bin/bash\\n\")])])]),a(\"p\",[s._v(\"我们使用阿里云的Ubuntu源，执行：\")]),s._v(\" \"),a(\"div\",{staticClass:\"language-bash extra-class\"},[a(\"pre\",{pre:!0,attrs:{class:\"language-bash\"}},[a(\"code\",[s._v(\"root@ubuntu:/\"),a(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"# cat > /etc/apt/sources.list << EOF\")]),s._v(\"\\ndeb http://mirrors.aliyun.com/ubuntu/ bionic main restricted universe multiverse\\ndeb-src http://mirrors.aliyun.com/ubuntu/ bionic main restricted universe multiverse\\n\\ndeb http://mirrors.aliyun.com/ubuntu/ bionic-security main restricted universe multiverse\\ndeb-src http://mirrors.aliyun.com/ubuntu/ bionic-security main restricted universe multiverse\\n\\ndeb http://mirrors.aliyun.com/ubuntu/ bionic-updates main restricted universe multiverse\\ndeb-src http://mirrors.aliyun.com/ubuntu/ bionic-updates main restricted universe multiverse\\n\\ndeb http://mirrors.aliyun.com/ubuntu/ bionic-proposed main restricted universe multiverse\\ndeb-src http://mirrors.aliyun.com/ubuntu/ bionic-proposed main restricted universe multiverse\\n \\ndeb http://mirrors.aliyun.com/ubuntu/ bionic-backports main restricted universe multiverse\\ndeb-src http://mirrors.aliyun.com/ubuntu/ bionic-backports main restricted universe multiverse\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\">\")]),s._v(\" EOF\\n\")])])]),a(\"p\",[s._v(\"成功后，原项目要求执行如下命令安装基本的软件环境：\")]),s._v(\" \"),a(\"div\",{staticClass:\"language-bash extra-class\"},[a(\"pre\",{pre:!0,attrs:{class:\"language-bash\"}},[a(\"code\",[a(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"apt-get\")]),s._v(\" update\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"apt-get\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"install\")]),s._v(\" -y \"),a(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"vim\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"wget\")]),s._v(\" python2.7 python-pip redis-tools dnsutils\\n\")])])]),a(\"p\",[s._v(\"初始化集群\\n首先，我们需要安装\"),a(\"code\",[s._v(\"redis-trib\")]),s._v(\"：\")]),s._v(\" \"),a(\"div\",{staticClass:\"language-bash extra-class\"},[a(\"pre\",{pre:!0,attrs:{class:\"language-bash\"}},[a(\"code\",[s._v(\"pip \"),a(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"install\")]),s._v(\" redis-trib\"),a(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"==\")]),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"0.5\")]),s._v(\".1\\n\")])])]),a(\"p\",[s._v(\"然后，创建只有Master节点的集群：\")]),s._v(\" \"),a(\"div\",{staticClass:\"language-bash extra-class\"},[a(\"pre\",{pre:!0,attrs:{class:\"language-bash\"}},[a(\"code\",[s._v(\"redis-trib.py create \"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"\\\\\")]),s._v(\"\\n  \"),a(\"span\",{pre:!0,attrs:{class:\"token variable\"}},[a(\"span\",{pre:!0,attrs:{class:\"token variable\"}},[s._v(\"`\")]),a(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"dig\")]),s._v(\" +short redis-app-0.redis-service.default.svc.cluster.local\"),a(\"span\",{pre:!0,attrs:{class:\"token variable\"}},[s._v(\"`\")])]),s._v(\":6379 \"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"\\\\\")]),s._v(\"\\n  \"),a(\"span\",{pre:!0,attrs:{class:\"token variable\"}},[a(\"span\",{pre:!0,attrs:{class:\"token variable\"}},[s._v(\"`\")]),a(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"dig\")]),s._v(\" +short redis-app-1.redis-service.default.svc.cluster.local\"),a(\"span\",{pre:!0,attrs:{class:\"token variable\"}},[s._v(\"`\")])]),s._v(\":6379 \"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"\\\\\")]),s._v(\"\\n  \"),a(\"span\",{pre:!0,attrs:{class:\"token variable\"}},[a(\"span\",{pre:!0,attrs:{class:\"token variable\"}},[s._v(\"`\")]),a(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"dig\")]),s._v(\" +short redis-app-2.redis-service.default.svc.cluster.local\"),a(\"span\",{pre:!0,attrs:{class:\"token variable\"}},[s._v(\"`\")])]),s._v(\":6379\\n\")])])]),a(\"p\",[s._v(\"其次，为每个Master添加Slave\")]),s._v(\" \"),a(\"div\",{staticClass:\"language-bash extra-class\"},[a(\"pre\",{pre:!0,attrs:{class:\"language-bash\"}},[a(\"code\",[s._v(\"redis-trib.py replicate \"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"\\\\\")]),s._v(\"\\n  --master-addr \"),a(\"span\",{pre:!0,attrs:{class:\"token variable\"}},[a(\"span\",{pre:!0,attrs:{class:\"token variable\"}},[s._v(\"`\")]),a(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"dig\")]),s._v(\" +short redis-app-0.redis-service.default.svc.cluster.local\"),a(\"span\",{pre:!0,attrs:{class:\"token variable\"}},[s._v(\"`\")])]),s._v(\":6379 \"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"\\\\\")]),s._v(\"\\n  --slave-addr \"),a(\"span\",{pre:!0,attrs:{class:\"token variable\"}},[a(\"span\",{pre:!0,attrs:{class:\"token variable\"}},[s._v(\"`\")]),a(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"dig\")]),s._v(\" +short redis-app-3.redis-service.default.svc.cluster.local\"),a(\"span\",{pre:!0,attrs:{class:\"token variable\"}},[s._v(\"`\")])]),s._v(\":6379\\n\\nredis-trib.py replicate \"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"\\\\\")]),s._v(\"\\n  --master-addr \"),a(\"span\",{pre:!0,attrs:{class:\"token variable\"}},[a(\"span\",{pre:!0,attrs:{class:\"token variable\"}},[s._v(\"`\")]),a(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"dig\")]),s._v(\" +short redis-app-1.redis-service.default.svc.cluster.local\"),a(\"span\",{pre:!0,attrs:{class:\"token variable\"}},[s._v(\"`\")])]),s._v(\":6379 \"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"\\\\\")]),s._v(\"\\n  --slave-addr \"),a(\"span\",{pre:!0,attrs:{class:\"token variable\"}},[a(\"span\",{pre:!0,attrs:{class:\"token variable\"}},[s._v(\"`\")]),a(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"dig\")]),s._v(\" +short redis-app-4.redis-service.default.svc.cluster.local\"),a(\"span\",{pre:!0,attrs:{class:\"token variable\"}},[s._v(\"`\")])]),s._v(\":6379\\n\\nredis-trib.py replicate \"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"\\\\\")]),s._v(\"\\n  --master-addr \"),a(\"span\",{pre:!0,attrs:{class:\"token variable\"}},[a(\"span\",{pre:!0,attrs:{class:\"token variable\"}},[s._v(\"`\")]),a(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"dig\")]),s._v(\" +short redis-app-2.redis-service.default.svc.cluster.local\"),a(\"span\",{pre:!0,attrs:{class:\"token variable\"}},[s._v(\"`\")])]),s._v(\":6379 \"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"\\\\\")]),s._v(\"\\n  --slave-addr \"),a(\"span\",{pre:!0,attrs:{class:\"token variable\"}},[a(\"span\",{pre:!0,attrs:{class:\"token variable\"}},[s._v(\"`\")]),a(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"dig\")]),s._v(\" +short redis-app-5.redis-service.default.svc.cluster.local\"),a(\"span\",{pre:!0,attrs:{class:\"token variable\"}},[s._v(\"`\")])]),s._v(\":6379\\n\")])])]),a(\"p\",[s._v(\"至此，我们的Redis集群就真正创建完毕了，连到任意一个Redis Pod中检验一下：\")]),s._v(\" \"),a(\"div\",{staticClass:\"language-bash extra-class\"},[a(\"pre\",{pre:!0,attrs:{class:\"language-bash\"}},[a(\"code\",[a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"[\")]),s._v(\"root@master redis\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"]\")]),a(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"# kubectl exec -it redis-app-2 /bin/bash\")]),s._v(\"\\nroot@redis-app-2:/data\"),a(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"# /usr/local/bin/redis-cli -c\")]),s._v(\"\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"127.0\")]),s._v(\".0.1:637\"),a(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[a(\"span\",{pre:!0,attrs:{class:\"token file-descriptor important\"}},[s._v(\"9\")]),s._v(\">\")]),s._v(\" cluster nodes\\n5d3e77f6131c6f272576530b23d1cd7592942eec \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"172.17\")]),s._v(\".24.3:6379@16379 master - \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"0\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"1559628533000\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"1\")]),s._v(\" connected \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"0\")]),s._v(\"-5461\\na4b529c40a920da314c6c93d17dc603625d6412c \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"172.17\")]),s._v(\".63.10:6379@16379 master - \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"0\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"1559628531670\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"6\")]),s._v(\" connected \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"10923\")]),s._v(\"-16383\\n368971dc8916611a86577a8726e4f1f3a69c5eb7 \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"172.17\")]),s._v(\".24.9:6379@16379 slave 0025e6140f85cb243c60c214467b7e77bf819ae3 \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"0\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"1559628533672\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"4\")]),s._v(\" connected\\n0025e6140f85cb243c60c214467b7e77bf819ae3 \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"172.17\")]),s._v(\".63.8:6379@16379 master - \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"0\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"1559628533000\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"2\")]),s._v(\" connected \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"5462\")]),s._v(\"-10922\\n6d5ee94b78b279e7d3c77a55437695662e8c039e \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"172.17\")]),s._v(\".24.8:6379@16379 myself,slave a4b529c40a920da314c6c93d17dc603625d6412c \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"0\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"1559628532000\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"5\")]),s._v(\" connected\\n2eb3e06ce914e0e285d6284c4df32573e318bc01 \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"172.17\")]),s._v(\".63.9:6379@16379 slave 5d3e77f6131c6f272576530b23d1cd7592942eec \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"0\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"1559628533000\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"3\")]),s._v(\" connected\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"127.0\")]),s._v(\".0.1:637\"),a(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[a(\"span\",{pre:!0,attrs:{class:\"token file-descriptor important\"}},[s._v(\"9\")]),s._v(\">\")]),s._v(\" cluster info\\ncluster_state:ok\\ncluster_slots_assigned:16384\\ncluster_slots_ok:16384\\ncluster_slots_pfail:0\\ncluster_slots_fail:0\\ncluster_known_nodes:6\\ncluster_size:3\\ncluster_current_epoch:6\\ncluster_my_epoch:6\\ncluster_stats_messages_ping_sent:14910\\ncluster_stats_messages_pong_sent:15139\\ncluster_stats_messages_sent:30049\\ncluster_stats_messages_ping_received:15139\\ncluster_stats_messages_pong_received:14910\\ncluster_stats_messages_received:30049\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"127.0\")]),s._v(\".0.1:637\"),a(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[a(\"span\",{pre:!0,attrs:{class:\"token file-descriptor important\"}},[s._v(\"9\")]),s._v(\">\")]),s._v(\" \\n\")])])]),a(\"p\",[s._v(\"另外，还可以在NFS上查看Redis挂载的数据：\")]),s._v(\" \"),a(\"div\",{staticClass:\"language-bash extra-class\"},[a(\"pre\",{pre:!0,attrs:{class:\"language-bash\"}},[a(\"code\",[a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"[\")]),s._v(\"root@ftp pv3\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"]\")]),a(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"# ll /usr/local/k8s/redis/pv3\")]),s._v(\"\\ntotal \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"12\")]),s._v(\"\\n-rw-r--r-- \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"1\")]),s._v(\" root root  \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"92\")]),s._v(\" Jun  \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"4\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"11\")]),s._v(\":36 appendonly.aof\\n-rw-r--r-- \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"1\")]),s._v(\" root root \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"175\")]),s._v(\" Jun  \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"4\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"11\")]),s._v(\":36 dump.rdb\\n-rw-r--r-- \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"1\")]),s._v(\" root root \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"794\")]),s._v(\" Jun  \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"4\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"11\")]),s._v(\":49 nodes.conf\\n\")])])]),a(\"h3\",{attrs:{id:\"_6-创建用于访问service\"}},[a(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_6-创建用于访问service\"}},[s._v(\"#\")]),s._v(\" 6.创建用于访问Service\")]),s._v(\" \"),a(\"p\",[s._v(\"前面我们创建了用于实现StatefulSet的Headless Service，但该Service没有Cluster Ip，因此不能用于外界访问。所以，我们还需要创建一个Service，专用于为Redis集群提供访问和负载均衡：\")]),s._v(\" \"),a(\"div\",{staticClass:\"language-yaml extra-class\"},[a(\"pre\",{pre:!0,attrs:{class:\"language-yaml\"}},[a(\"code\",[a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"[\")]),s._v(\"root@master redis\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"]\")]),a(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"# cat redis-access-service.yaml \")]),s._v(\"\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"apiVersion\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" v1\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"kind\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" Service\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"metadata\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n  \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"name\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" redis\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"-\")]),s._v(\"access\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"-\")]),s._v(\"service\\n  \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"labels\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n    \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"app\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" redis\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"spec\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n  \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"ports\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n  \"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"-\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"name\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" redis\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"-\")]),s._v(\"port\\n    \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"protocol\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"TCP\"')]),s._v(\"\\n    \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"port\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"6379\")]),s._v(\"\\n    \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"targetPort\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"6379\")]),s._v(\"\\n  \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"selector\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n    \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"app\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" redis\\n    \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"appCluster\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" redis\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"-\")]),s._v(\"cluster\\n\\n\")])])]),a(\"p\",[s._v(\"如上，该Service名称为 \"),a(\"code\",[s._v(\"redis-access-service\")]),s._v(\"，在K8S集群中暴露6379端口，并且会对\"),a(\"code\",[s._v(\"labels name\")]),s._v(\"为\"),a(\"code\",[s._v(\"app: redis\")]),s._v(\"或\"),a(\"code\",[s._v(\"appCluster: redis-cluster\")]),s._v(\"的pod进行负载均衡。\")]),s._v(\" \"),a(\"p\",[s._v(\"创建后查看：\")]),s._v(\" \"),a(\"div\",{staticClass:\"language-bash extra-class\"},[a(\"pre\",{pre:!0,attrs:{class:\"language-bash\"}},[a(\"code\",[a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"[\")]),s._v(\"root@master redis\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"]\")]),a(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"#  kubectl get svc redis-access-service -o wide\")]),s._v(\"\\nNAME                   TYPE        CLUSTER-IP   EXTERNAL-IP   PORT\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),s._v(\"S\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\"    AGE       SELECTOR\\nredis-access-service   ClusterIP   \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"10.0\")]),s._v(\".0.64    \"),a(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"<\")]),s._v(\"none\"),a(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\">\")]),s._v(\"        \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"6379\")]),s._v(\"/TCP   2h        \"),a(\"span\",{pre:!0,attrs:{class:\"token assign-left variable\"}},[s._v(\"app\")]),a(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),s._v(\"redis,appCluster\"),a(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),s._v(\"redis-cluster\\n\")])])]),a(\"p\",[s._v(\"如上，在K8S集群中，所有应用都可以通过\"),a(\"code\",[s._v(\"10.0.0.64 :6379\")]),s._v(\"来访问Redis集群。当然，为了方便测试，我们也可以为Service添加一个NodePort映射到物理机上，这里不再详细介绍。\")]),s._v(\" \"),a(\"h2\",{attrs:{id:\"五、测试主从切换\"}},[a(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#五、测试主从切换\"}},[s._v(\"#\")]),s._v(\" 五、测试主从切换\")]),s._v(\" \"),a(\"p\",[s._v(\"在K8S上搭建完好Redis集群后，我们最关心的就是其原有的高可用机制是否正常。这里，我们可以任意挑选一个Master的Pod来测试集群的主从切换机制，如\"),a(\"code\",[s._v(\"redis-app-0\")]),s._v(\"：\")]),s._v(\" \"),a(\"div\",{staticClass:\"language-bash extra-class\"},[a(\"pre\",{pre:!0,attrs:{class:\"language-bash\"}},[a(\"code\",[a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"[\")]),s._v(\"root@master redis\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"]\")]),a(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"# kubectl get pods redis-app-0 -o wide\")]),s._v(\"\\nNAME          READY     STATUS    RESTARTS   AGE       IP            NODE            NOMINATED NODE\\nredis-app-1   \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"1\")]),s._v(\"/1       Running   \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"0\")]),s._v(\"          3h        \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"172.17\")]),s._v(\".24.3   \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"192.168\")]),s._v(\".0.144   \"),a(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"<\")]),s._v(\"none\"),a(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\">\")]),s._v(\"\\n\")])])]),a(\"p\",[s._v(\"进入\"),a(\"code\",[s._v(\"redis-app-0\")]),s._v(\"查看：\")]),s._v(\" \"),a(\"div\",{staticClass:\"language-bash extra-class\"},[a(\"pre\",{pre:!0,attrs:{class:\"language-bash\"}},[a(\"code\",[a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"[\")]),s._v(\"root@master redis\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"]\")]),a(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"# kubectl exec -it redis-app-0 /bin/bash\")]),s._v(\"\\nroot@redis-app-0:/data\"),a(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"# /usr/local/bin/redis-cli -c\")]),s._v(\"\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"127.0\")]),s._v(\".0.1:637\"),a(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[a(\"span\",{pre:!0,attrs:{class:\"token file-descriptor important\"}},[s._v(\"9\")]),s._v(\">\")]),s._v(\" role\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"1\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"master\"')]),s._v(\"\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"2\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),s._v(\"integer\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"13370\")]),s._v(\"\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"3\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"1\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"1\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"172.17.63.9\"')]),s._v(\"\\n      \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"2\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"6379\"')]),s._v(\"\\n      \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"3\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"13370\"')]),s._v(\"\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"127.0\")]),s._v(\".0.1:637\"),a(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[a(\"span\",{pre:!0,attrs:{class:\"token file-descriptor important\"}},[s._v(\"9\")]),s._v(\">\")]),s._v(\" \\n\")])])]),a(\"p\",[s._v(\"如上可以看到，\"),a(\"code\",[s._v(\"app-0\")]),s._v(\"为master，slave为\"),a(\"code\",[s._v(\"172.17.63.9\")]),s._v(\"即\"),a(\"code\",[s._v(\"redis-app-3\")]),s._v(\"。\")]),s._v(\" \"),a(\"p\",[s._v(\"接着，我们手动删除\"),a(\"code\",[s._v(\"redis-app-0\")]),s._v(\"：\")]),s._v(\" \"),a(\"div\",{staticClass:\"language-bash extra-class\"},[a(\"pre\",{pre:!0,attrs:{class:\"language-bash\"}},[a(\"code\",[a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"[\")]),s._v(\"root@master redis\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"]\")]),a(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"# kubectl delete pod redis-app-0\")]),s._v(\"\\npod \"),a(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"redis-app-0\"')]),s._v(\" deleted\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"[\")]),s._v(\"root@master redis\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"]\")]),a(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"#  kubectl get pod redis-app-0 -o wide\")]),s._v(\"\\nNAME          READY     STATUS    RESTARTS   AGE       IP            NODE            NOMINATED NODE\\nredis-app-0   \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"1\")]),s._v(\"/1       Running   \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"0\")]),s._v(\"          4m        \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"172.17\")]),s._v(\".24.3   \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"192.168\")]),s._v(\".0.144   \"),a(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"<\")]),s._v(\"none\"),a(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\">\")]),s._v(\"\\n\")])])]),a(\"p\",[s._v(\"我们再进入\"),a(\"code\",[s._v(\"redis-app-0\")]),s._v(\"内部查看：\")]),s._v(\" \"),a(\"div\",{staticClass:\"language-bash extra-class\"},[a(\"pre\",{pre:!0,attrs:{class:\"language-bash\"}},[a(\"code\",[a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"[\")]),s._v(\"root@master redis\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"]\")]),a(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"# kubectl exec -it redis-app-0 /bin/bash\")]),s._v(\"\\nroot@redis-app-0:/data\"),a(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"# /usr/local/bin/redis-cli -c\")]),s._v(\"\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"127.0\")]),s._v(\".0.1:637\"),a(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[a(\"span\",{pre:!0,attrs:{class:\"token file-descriptor important\"}},[s._v(\"9\")]),s._v(\">\")]),s._v(\" role\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"1\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"slave\"')]),s._v(\"\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"2\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"172.17.63.9\"')]),s._v(\"\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"3\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),s._v(\"integer\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"6379\")]),s._v(\"\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"4\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"connected\"')]),s._v(\"\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"5\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),s._v(\"integer\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"13958\")]),s._v(\"\\n\")])])]),a(\"p\",[s._v(\"如上，\"),a(\"code\",[s._v(\"redis-app-0\")]),s._v(\"变成了slave，从属于它之前的从节点\"),a(\"code\",[s._v(\"172.17.63.9\")]),s._v(\"即\"),a(\"code\",[s._v(\"redis-app-3\")]),s._v(\"。\")]),s._v(\" \"),a(\"h2\",{attrs:{id:\"六、疑问\"}},[a(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#六、疑问\"}},[s._v(\"#\")]),s._v(\" 六、疑问\")]),s._v(\" \"),a(\"p\",[s._v(\"至此，大家可能会疑惑，那为什么没有使用稳定的标志，Redis Pod也能正常进行故障转移呢？这涉及了Redis本身的机制。因为，Redis集群中每个节点都有自己的NodeId（保存在自动生成的nodes.conf中），并且该NodeId不会随着IP的变化和变化，这其实也是一种固定的网络标志。也就是说，就算某个Redis Pod重启了，该Pod依然会加载保存的NodeId来维持自己的身份。我们可以在NFS上查看redis-app-1的nodes.conf文件：\")]),s._v(\" \"),a(\"div\",{staticClass:\"language-bash extra-class\"},[a(\"pre\",{pre:!0,attrs:{class:\"language-bash\"}},[a(\"code\",[a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"[\")]),s._v(\"root@k8s-node2 ~\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"]\")]),a(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"# cat /usr/local/k8s/redis/pv1/nodes.conf \")]),s._v(\"\\n96689f2018089173e528d3a71c4ef10af68ee462 \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"192.168\")]),s._v(\".169.209:6379@16379 slave d884c4971de9748f99b10d14678d864187a9e5d3 \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"0\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"1526460952651\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"4\")]),s._v(\" connected237d46046d9b75a6822f02523ab894928e2300e6 \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"192.168\")]),s._v(\".169.200:6379@16379 slave c15f378a604ee5b200f06cc23e9371cbc04f4559 \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"0\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"1526460952651\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"1\")]),s._v(\" connected\\nc15f378a604ee5b200f06cc23e9371cbc04f4559 \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"192.168\")]),s._v(\".169.197:6379@16379 master - \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"0\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"1526460952651\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"1\")]),s._v(\" connected \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"10923\")]),s._v(\"-16383d884c4971de9748f99b10d14678d864187a9e5d3 \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"192.168\")]),s._v(\".169.205:6379@16379 master - \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"0\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"1526460952651\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"4\")]),s._v(\" connected \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"5462\")]),s._v(\"-10922c3b4ae23c80ffe31b7b34ef29dd6f8d73beaf85f \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"192.168\")]),s._v(\".169.198:6379@16379 myself,slave c8a8f70b4c29333de6039c47b2f3453ed11fb5c2 \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"0\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"1526460952565\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"3\")]),s._v(\" connected\\nc8a8f70b4c29333de6039c47b2f3453ed11fb5c2 \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"192.168\")]),s._v(\".169.201:6379@16379 master - \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"0\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"1526460952651\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"6\")]),s._v(\" connected \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"0\")]),s._v(\"-5461vars currentEpoch \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"6\")]),s._v(\" lastVoteEpoch \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"4\")]),s._v(\"\\n\")])])]),a(\"p\",[s._v(\"如上，第一列为NodeId，稳定不变；第二列为IP和端口信息，可能会改变。\")]),s._v(\" \"),a(\"p\",[s._v(\"这里，我们介绍NodeId的两种使用场景：\")]),s._v(\" \"),a(\"p\",[s._v(\"当某个Slave Pod断线重连后IP改变，但是Master发现其NodeId依旧， 就认为该Slave还是之前的Slave。\")]),s._v(\" \"),a(\"p\",[s._v(\"当某个Master Pod下线后，集群在其Slave中选举重新的Master。待旧Master上线后，集群发现其NodeId依旧，会让旧Master变成新Master的slave。\")]),s._v(\" \"),a(\"p\",[s._v(\"对于这两种场景，大家有兴趣的话还可以自行测试，注意要观察Redis的日志。\")])])}),[],!1,null,null,null);t.default=n.exports}}]);","extractedComments":[]}